/*!
 * Mumlife - Common Scripts.
 *
 * @version     2014-02-27 1.1.0
 * @author      Michael Giuliano <michael@beatscope.co.uk>
 * @copyright   2014 Beatscope Limited | http://www.beatscope.co.uk/
 */
/*!
 * jQuery Cookie plugin
 *
 * Copyright (c) 2010 Klaus Hartl (stilbuero.de)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * Source: https://github.com/carhartl/jquery-cookie
 */
jQuery.cookie=function(e,f,b){if(arguments.length>1&&String(f)!=="[object Object]"){b=jQuery.extend({},b);if(f===null||f===undefined){b.expires=-1}if(typeof b.expires==="number"){var h=b.expires,c=b.expires=new Date();c.setDate(c.getDate()+h)}f=String(f);return(document.cookie=[encodeURIComponent(e),"=",b.raw?f:encodeURIComponent(f),b.expires?"; expires="+b.expires.toUTCString():"",b.path?"; path="+b.path:"",b.domain?"; domain="+b.domain:"",b.secure?"; secure":""].join(""))}b=f||{};var a,g=b.raw?function(i){return i}:decodeURIComponent;return(a=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie))?g(a[1]):null};
/*!
*   @name                           Elastic
*   @descripton                     Elastic is jQuery plugin that grow and shrink your textareas automatically
*   @version                        1.6.11
*   @requires                       jQuery 1.2.6+
*
*   @author                         Jan Jarfalk
*   @author-email                   jan.jarfalk@unwrongest.com
*   @author-website                 http://www.unwrongest.com
*
*   @licence                        MIT License - http://www.opensource.org/licenses/mit-license.php
*/
(function(a){jQuery.fn.extend({elastic:function(){var b=["paddingTop","paddingRight","paddingBottom","paddingLeft","fontSize","lineHeight","fontFamily","width","fontWeight","border-top-width","border-right-width","border-bottom-width","border-left-width","borderTopStyle","borderTopColor","borderRightStyle","borderRightColor","borderBottomStyle","borderBottomColor","borderLeftStyle","borderLeftColor"];return this.each(function(){if(this.type!=="textarea"){return false}var h=jQuery(this),c=jQuery("<div />").css({position:"absolute",display:"none","word-wrap":"break-word","white-space":"pre-wrap"}),k=parseInt(h.css("line-height"),10)||parseInt(h.css("font-size"),"10"),m=parseInt(h.css("height"),10)||k*3,l=parseInt(h.css("max-height"),10)||Number.MAX_VALUE,e=0;if(l<0){l=Number.MAX_VALUE}c.attr("id",h.attr("id")+"-twin");c.appendTo(h.parent());var g=b.length;while(g--){c.css(b[g].toString(),h.css(b[g].toString()))}function j(){var i=Math.floor(parseInt(h.width(),10));if(c.width()!==i){c.css({width:i+"px"});f(true)}}function n(i,p){var o=Math.floor(parseInt(i,10));if(h.height()!==o){h.css({height:o+"px",overflow:p})}}function f(q){var p=h.val().replace(/&/g,"&amp;").replace(/ {2}/g,"&nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />");var i=c.html().replace(/<br>/ig,"<br />");if(q||p+"&nbsp;"!==i){c.html(p+"&nbsp;");if(Math.abs(c.height()+k-h.height())>3){var o=c.height()+k;if(o>=l){n(l,"auto")}else{if(o<=m){n(m,"hidden")}else{n(o,"hidden")}}}}}h.css({overflow:"hidden"});h.bind("keyup change cut paste",function(i){f()});a(window).bind("resize",j);h.bind("resize",j);h.bind("update",f);h.bind("input paste",function(i){setTimeout(f,250)});f()})}})})(jQuery);
/*!
 * Mumlife - Common Scripts
 * (c) 2014 Beatscope Limited | http://www.beatscope.co.uk/
 */
function csrfSafeMethod(a){return(/^(GET|HEAD|OPTIONS|TRACE)$/.test(a))}$.ajaxSetup({crossDomain:true,cache:true,beforeSend:function(c,b){var a=$.cookie("csrftoken");if(!csrfSafeMethod(b.type)){c.setRequestHeader("X-CSRFToken",a);c.setRequestHeader("X-Requested-With","XMLHttpRequest")}}});if(typeof(ML)==="undefined"){var ML={}}function trim(b){if(!b||typeof(b)==="undefined"){return""}b=b.replace(/^\s+/,"");for(var a=b.length-1;a>=0;a--){if(/\S/.test(b.charAt(a))){b=b.substring(0,a+1);break}}return b}ML.Utils=function(){};ML.Utils.prototype.preventEnterSubmit=function(c){if(c.which==13){var a=$(c.target);if(!a.is("textarea")&&!a.is(":button,:submit")){var b=false;$(this).find(":input:visible:not([disabled],[readonly]), a").each(function(){if(this===c.target){b=true}else{if(b){$(this).focus();return false}}});return false}}};ML.utils=new ML.Utils();ML.Settings=function(a){this.settings={site_url:a.site_url,static_url:a.hasOwnProperty("static_url")?a.static_url:"/static/",api_url:a.api_url,csrf_token:$.cookie("csrftoken")}};ML.Settings.prototype.getSettings=function(){return this.settings};ML.Settings.prototype.get=function(a){if(this.settings.hasOwnProperty(a)){return this.settings[a]}};ML.Application=function(a){ML.settings=new ML.Settings(a);this.init()};ML.Application.prototype.init=function(){this.version=null;if(location.search){var a=location.search.substr(1).split("&");for(var c in a){var b=a[c].split("=");if(b[0]=="version"){this.version=trim(b[1]);if(this.version==""){this.version=null}$.cookie("version",this.version,{path:"/"});location.search=location.search.replace("?"+a[c],"").replace("&"+a[c],"");break}}}if($.cookie("version")){this.version=$.cookie("version")}if(!this.version){if(platform.product){this.version="mobile"}else{this.version="desktop"}}if(!$.cookie("ck_allowed")){setTimeout(function(){$("#mumlifecookies").slideDown()},500);$("#cookies-continue-button").click(function(){$.cookie("ck_allowed",1,{expires:365,path:"/"});$("#mumlifecookies").slideUp()})}new ML.Menu();new ML.Search();new ML.Slider();new ML.FullScreen();setTimeout(function(){new ML.Notifications()},250);$(document).trigger("ml.Ready")};if(!window.ML){window.ML=ML}ML.Menu=function(){$('[data-entity="menu"]').click(function(){if($("#menu").is(":visible")){$("#menu").slideUp(250)}else{$("#menu").slideDown(250)}$(this).blur();return false})};ML.Search=function(){$('[data-entity="search"]').click(function(){if($('[data-entity="search-form"]').is(":visible")){$('[data-entity="search-form"]').slideUp(250)}else{$('[data-entity="search-form"]').slideDown(250,function(){$('[data-entity="search"]').blur();$('[data-entity="search-form"] input[type="text"]').focus()})}return false})};ML.Slider=function(){$('[data-entity="slider"]').click(function(){if($('[data-entity="slider-form"]').is(":visible")){$('[data-entity="slider-form"]').slideUp(250)}else{$('[data-entity="slider-form"]').slideDown(250)}$(this).blur();return false})};ML.FullScreen=function(){};ML.Notifications=function(){var b=$('[data-entity="notifications"]');if(b.size()>0){var a=ML.settings.get("site_url")+"notifications/";$("#notifications").popup({afteropen:function(c,e){$.mobile.loading("show");$("#notifications-content").html("<p><em>Loading notifications</em></p>");$("#notifications").popup("reposition",{x:0,y:0,positionTo:"body"});$.ajax({url:a,type:"GET",contentType:"text/html; charset=UTF-8",success:function(f){$.mobile.loading("hide");b.removeClass("active");$("#notifications-content").html(f);$("#notifications").popup("reposition",{x:0,y:0,positionTo:"body"})},error:function(f){$.mobile.loading("hide");console.log("FAILED -- "+f)}})},afterclose:function(c,e){$("#notifications-content").empty();$.mobile.loading("hide")}});b.on("click",function(){$("#notifications").popup("open");return false})}b.removeClass("invisible")};ML.Upload=function(c){this.url=ML.settings.get("site_url")+"upload";this.model=c.model;this.field=c.field;if(c.hasOwnProperty("width")){this.width=c.width}else{this.width="auto"}if(c.hasOwnProperty("height")){this.height=c.height}else{this.height="auto"}var a=this;$("input#"+this.field+"-clear_id").attr("checked",false);$("input#"+this.field+"-clear_id").change(function(){a.set_image_visibility(a.field,!$(this).is(":checked"))});var b={csrfmiddlewaretoken:ML.settings.get("csrf_token"),model:this.model,field:this.field};if(this.width!=="auto"){b.width=this.width}if(this.height!=="auto"){b.height=this.height}$("input#id_"+this.field).ajaxfileupload({action:a.url,params:b,onComplete:function(g){if($("img."+a.field+"-edit").length>0){$("img."+a.field+"-edit").attr("src",g.filename)}else{var f=$("<img>");f.addClass(a.field+"-edit");f.attr("width",a.width);f.attr("height",a.height);f.attr("src",g.filename);$("input#id_"+a.field).before(f)}$("input#id_"+a.field+"_filepath").remove();var e=$("<input>");e.attr("type","hidden");e.val(g.filename);e.attr("name",a.field);e.attr("id","id_"+a.field+"_filepath");$("input#id_"+a.field).after(e);$.mobile.loading("hide");a.set_image_visibility(a.field,true);$('[data-entity="'+a.field+'-clear_id"]').show()},onStart:function(){$.mobile.loading("show");if($("img."+a.field+"-edit").length>0){a.set_image_visibility(a.field,false)}}})};ML.Upload.prototype.set_image_visibility=function(b,a){if(a){$("img."+b+"-edit").slideDown(250).show();$("#id_"+b).show();$("#"+b+"_change").show();$(".picture-rotate").show()}else{$("img."+b+"-edit").slideUp(250).hide();$("#id_"+b).hide();$("#"+b+"_change").hide();$(".picture-rotate").hide()}};ML.ImageRotate=function(c){var a=this;var e=c.field;var b=$('[data-entity="image-rotate"]');b.on("click",function(){$.ajax({url:"/manipulate/rotate",data:{field:"picture"},type:"POST",contentType:"application/x-www-form-urlencoded;charset=utf-8",dataType:"json",success:function(f){d=new Date();$("."+e).attr("src",f.filename+"?"+d.getTime())},error:function(g){try{console.log("FAILED -- "+JSON.parse(g.responseText).detail)}catch(f){console.log("FAILED");console.log(g)}}});return false})};ML.Feed=function(c){var a=this;this.loading=false;this.settings=c;this.button=$(".feed .ui-btn");this.button.click(function(){a.refresh();return false});if(c.hasOwnProperty("filters")&&c.filters){this.setFilters()}if(c.hasOwnProperty("slider")&&c.slider){var f=new RegExp(/\?range=.+/g);var e=f.exec(location.search);if(e){var b=e.pop().split("=").pop();setTimeout(function(){$("#range").val(b);$("#range").slider("refresh")},250);$.cookie("ml_range",b)}$("#filter").on("click",function(g){a.slide($("#range").val());return false})}if(c.next!=""){this.button.show()}if(this.settings.hasOwnProperty("autoscroll")&&this.settings.autoscroll){$(window).scroll(function(){if(!a.loading&&c.next!=""){var g=$(".ui-page").height()-280;if($(document).scrollTop()+$(window).height()>=g){a.refresh()}}})}};ML.Feed.prototype.setFilters=function(){var b=$(".search-form").find('input[type="text"]').val();var c=new RegExp(/@\w+/g);var a=c.exec(b);a=a?a[0]:null;switch(a){case"@global":$('[data-role="filter-name"]').text("Global posts");$('[data-entity="filter"][rel="@local"]').removeClass("active");$('[data-entity="filter"][rel="@global"]').addClass("active");$('[data-entity="filter"][rel="@friends"]').removeClass("active");break;case"@friends":$('[data-role="filter-name"]').text("Friends' posts");$('[data-entity="filter"][rel="@local"]').removeClass("active");$('[data-entity="filter"][rel="@global"]').removeClass("active");$('[data-entity="filter"][rel="@friends"]').addClass("active");break;default:$('[data-role="filter-name"]').text("Local posts");$('[data-entity="filter"][rel="@local"]').addClass("active");$('[data-entity="filter"][rel="@global"]').removeClass("active");$('[data-entity="filter"][rel="@friends"]').removeClass("active")}$('[data-entity="filter"]').click(function(){var g=$(".search-form").find('input[type="text"]').val().split(" ");var e=[];for(var f in g){if(g[f].charAt(0)!="@"){e.push(escape(g[f]))}}e.push($(this).attr("rel"));location=trim(e.join(" "));return false})};ML.Feed.prototype.slide=function(c){var a=new RegExp(/\?range=.+/g);var b=location.href;if(a.exec(b)){b=b.replace(a,"?range="+c)}else{b+="?range="+c}location=b};ML.Feed.prototype.refresh=function(){var a=this;this.loading=true;$.mobile.loading("show");this.button.remove();if(this.settings.next!=""){this.settings.next=this.settings.next.replace("&amp;","&");var b=ML.settings.get("site_url")+this.settings.next;$.ajax({url:b,type:"GET",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(c){$(".feed").append(c.html_content).append(a.button);a.button.click(function(){a.refresh();return false});a.settings.next=c.next;a.finish()},error:function(c){console.log("FAILED -- "+c);a.finish()}})}};ML.Feed.prototype.finish=function(){if(this.settings.next!=""){this.button.show();this.button.blur()}else{this.button.hide()}$.mobile.loading("hide");this.loading=false};ML.Messages=function(a){this.mode=a&&a.hasOwnProperty("edit-mode")&&a["edit-mode"]?"PATCH":"POST";this.event_id=a&&a.hasOwnProperty("event_id")?a.event_id:null;this.refresh()};ML.Messages.prototype.refresh=function(){var b=this;$("textarea.message-body").unbind();$("textarea.message-body").elastic();var c=$(".message-visibility").find('option[selected="selected"]');$('a[data-entity="message-type"]').each(function(){if($(this).data("type")==c.val()){$(this).addClass("selected")}});$('a[data-entity="message-type"]').click(function(){$('a[data-entity="message-type"]').removeClass("selected");$(this).addClass("selected");$(".message-visibility").find("option").attr("selected",null);$(".message-visibility").find('option[value="'+$(this).data("type")+'"]').attr("selected","selected");return false});function a(e){if(e==0){$('[data-entity="occurrence-until"]').slideUp(250)}else{$('[data-entity="occurrence-until"]').slideDown(250)}}a($('[data-entity="occurrence"] input:checked').val());$('[data-entity="occurrence"] input').off("change").on("change",function(){a($(this).val())});$('[data-entity="message"]').each(function(){var e=$(this);if(!e.data("bound")){e.data("bound",true);var f=null;if(e.data("type")=="private-message"){if(e.find('[data-entity="recipient"]').size()>0){e.find('[data-entity="recipient"]').on("click",function(){$(this).off("click").on("click",function(){return false});f=$(this).data("id");$(this).html('<p class="message-recipient">To: <strong>'+$(this).text()+"</strong></p>");$('[data-entity="friends-list"]').replaceWith($(this));return false})}else{f=e.data("recipient")}}e.find('[data-entity="button"]').bind("click",function(){var m=[];var l=trim(e.find(".message-body").val());var h=null;if(e.data("type")=="private-message"){h=0;if(!f){m.push("<p>Please select a friend</p>")}}else{var o=e.find(".message-visibility");if(o.size()>0){h=e.find(".message-visibility").find('option[selected="selected"]').val()}else{h=2}}var j=null;if($(".picture-edit").size()>0&&$(".picture-edit").is(":visible")){j=$(".picture-edit").attr("src")}var k={body:l,picture:j,visibility:parseInt(h),mid:e.data("mid"),recipient:f};if(b.event_id){k.id=b.event_id}var p=$("#id_tags");if(p.size()>0){k.tags=p.val()}var n=false;if(e.find(".message-name").length>0){n=true;k.name=e.find(".message-name").val();var i=e.find(".message-date").val();k.eventdate=i;if(e.find(".message-time").val()==""){k.eventdate+=" 00:00"}else{k.eventdate+=" "+e.find(".message-time").val()}if(e.find(".message-endtime").val()!=""){k.eventenddate=i+" "+e.find(".message-endtime").val()}k.location=e.find(".message-location").val();k.visibility=3;k.occurrence=parseInt(e.find('[data-entity="occurrence"] input:checked').val());k.occurs_until=e.find('[data-entity="occurrence-until"] input').val()}var g=true;e.find('*[required="required"]').each(function(){if($(this).val()==""){m.push("<p><strong>"+$(this).data("name")+"</strong> is required</p>")}});if(m.length>0){g=false;$("#errors-content").html(m.join(""));$("#errors").popup("open")}if(g){$.ajax({url:ML.settings.get("api_url")+"message/post",data:JSON.stringify(k),type:b.mode,contentType:"application/json; charset=UTF-8",dataType:"json",success:function(q){mixpanel.track("Post Sent",{"Is Event":n},function(){if(n){location=ML.settings.get("site_url")+"events/"}else{if(e.data("type")=="message"){location=ML.settings.get("site_url")}else{location.reload(true)}}})},error:function(r){try{console.log("FAILED -- "+JSON.parse(r.responseText).detail)}catch(q){console.log("FAILED -- "+r)}}})}})}});$('a[data-entity="message"]').click(function(){var e=$(this);var f=$('div[data-entity="message"]');if(f.is(":visible")){f.slideUp(250,function(){f.find("textarea").val("")})}else{f.slideDown(250,function(){if(f.find('input[data-type="search"]').size()>0){f.find('input[data-type="search"]').focus()}else{f.find("textarea").focus()}})}return false})};ML.AutoField=function(b){var a=this;this.model=b.model;this.entity=b.entity;this.field=$("#id_"+b.field);this.widget=b.hasOwnProperty("widget")?b.widget:null;this.value=this.field.val();switch(this.widget){case"elastic":this.value=$("#id_"+b.field+"-twin").text();break;case"select":this.value=$("#id_"+b.field).data("value");var c=this.field.find("input");c.click(function(){a.field.val($(this).val());a.update()});break;case"date":this.field.on("change",function(){var e=a.field.val();if(e!==a.value){a.update()}});break}this.field.on("blur",function(){var e=a.field.val();if(e!==a.value){a.update()}});$(window).on("beforeunload",function(g){var f=a.field.val();if(f&&f!==a.value){a.update(function(){return true})}})};ML.AutoField.prototype.update=function(e){this.field.attr("disabled","disabled");var b=ML.settings.get("api_url")+this.model+"/"+this.entity+"/";var c={};c[this.field.attr("name")]=this.field.val();var a=this;$.ajax({url:b,data:JSON.stringify(c),async:false,type:"PATCH",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(f){a.done();if(typeof(e)=="function"){e()}},error:function(j){try{var h=["Oops something went wrong!\n"];var k=JSON.parse(j.responseText);for(var i in k){h.push(k[i])}alert(h.join("\n"))}catch(g){console.log("FAILED -- "+g)}a.done();if(typeof(e)=="function"){e()}}})};ML.AutoField.prototype.done=function(){this.value=this.field.val();this.field.attr("disabled",null)};ML.AddToFriends=function(b){this.classname=b["class"];var a=this;$("a."+this.classname).click(function(){var f=$(this);var h=f.attr("href").replace("#","").split(",");var e=ML.settings.get("api_url")+"friendships/";var c=0;if(f.attr("rel")=="block"){c=2}var g={from_member:parseInt(h[0]),to_member:parseInt(h[1]),status:c};$.ajax({url:e,data:JSON.stringify(g),type:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(i){f.unbind("click").click(function(){return false});if(f.attr("rel")=="confirm"){f.find("img").removeClass("icon-addtofriend").addClass("icon-friend");f.find("span").text("Friend")}else{if(f.attr("rel")=="block"){f.find("img").removeClass("icon-addtofriend").addClass("icon-addtofriend");f.find("span").text("Blocked")}else{f.find("img").removeClass("icon-addtofriend").addClass("icon-pendingfriend");f.find("span").text("Requested")}}},error:function(j){try{if(JSON.parse(j.responseText).detail=="Already Exists"){}}catch(i){console.log("FAILED -- "+i)}}});return false})};