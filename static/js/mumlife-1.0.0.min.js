/**
 * Mumlife - Common Scripts.
 *
 * @version     2014-01-20 1.0.0
 * @author      Michael Giuliano <michael@beatscope.co.uk>
 * @copyright   2014 Beatscope Limited | http://www.beatscope.co.uk/
 */
jQuery.cookie=function(d,e,b){if(arguments.length>1&&String(e)!=="[object Object]"){b=jQuery.extend({},b);if(e===null||e===undefined){b.expires=-1}if(typeof b.expires==="number"){var g=b.expires,c=b.expires=new Date();c.setDate(c.getDate()+g)}e=String(e);return(document.cookie=[encodeURIComponent(d),"=",b.raw?e:encodeURIComponent(e),b.expires?"; expires="+b.expires.toUTCString():"",b.path?"; path="+b.path:"",b.domain?"; domain="+b.domain:"",b.secure?"; secure":""].join(""))}b=e||{};var a,f=b.raw?function(h){return h}:decodeURIComponent;return(a=new RegExp("(?:^|; )"+encodeURIComponent(d)+"=([^;]*)").exec(document.cookie))?f(a[1]):null};(function(a){jQuery.fn.extend({elastic:function(){var b=["paddingTop","paddingRight","paddingBottom","paddingLeft","fontSize","lineHeight","fontFamily","width","fontWeight","border-top-width","border-right-width","border-bottom-width","border-left-width","borderTopStyle","borderTopColor","borderRightStyle","borderRightColor","borderBottomStyle","borderBottomColor","borderLeftStyle","borderLeftColor"];return this.each(function(){if(this.type!=="textarea"){return false}var g=jQuery(this),c=jQuery("<div />").css({position:"absolute",display:"none","word-wrap":"break-word","white-space":"pre-wrap"}),j=parseInt(g.css("line-height"),10)||parseInt(g.css("font-size"),"10"),l=parseInt(g.css("height"),10)||j*3,k=parseInt(g.css("max-height"),10)||Number.MAX_VALUE,d=0;if(k<0){k=Number.MAX_VALUE}c.attr("id",g.attr("id")+"-twin");c.appendTo(g.parent());var f=b.length;while(f--){c.css(b[f].toString(),g.css(b[f].toString()))}function h(){var i=Math.floor(parseInt(g.width(),10));if(c.width()!==i){c.css({width:i+"px"});e(true)}}function m(i,o){var n=Math.floor(parseInt(i,10));if(g.height()!==n){g.css({height:n+"px",overflow:o})}}function e(p){var o=g.val().replace(/&/g,"&amp;").replace(/ {2}/g,"&nbsp;").replace(/<|>/g,"&gt;").replace(/\n/g,"<br />");var i=c.html().replace(/<br>/ig,"<br />");if(p||o+"&nbsp;"!==i){c.html(o+"&nbsp;");if(Math.abs(c.height()+j-g.height())>3){var n=c.height()+j;if(n>=k){m(k,"auto")}else{if(n<=l){m(l,"hidden")}else{m(n,"hidden")}}}}}g.css({overflow:"hidden"});g.bind("keyup change cut paste",function(i){e()});a(window).bind("resize",h);g.bind("resize",h);g.bind("update",e);g.bind("input paste",function(i){setTimeout(e,250)});e()})}})})(jQuery);function csrfSafeMethod(a){return(/^(GET|HEAD|OPTIONS|TRACE)$/.test(a))}$.ajaxSetup({crossDomain:true,cache:true,beforeSend:function(c,b){var a=$.cookie("csrftoken");if(!csrfSafeMethod(b.type)){c.setRequestHeader("X-CSRFToken",a);c.setRequestHeader("X-Requested-With","XMLHttpRequest")}}});if(typeof(ML)==="undefined"){var ML={}}function trim(b){if(!b||typeof(b)==="undefined"){return""}b=b.replace(/^\s+/,"");for(var a=b.length-1;a>=0;a--){if(/\S/.test(b.charAt(a))){b=b.substring(0,a+1);break}}return b}ML.Utils=function(){};ML.Utils.prototype.set_image_visibility=function(b,a){if(a){$("img."+b+"-edit").slideDown(250).show();$("#"+b+"_change").show()}else{$("img."+b+"-edit").slideUp(250).hide();$("#"+b+"_change").hide()}};ML.Utils.prototype.preventEnterSubmit=function(c){if(c.which==13){var a=$(c.target);if(!a.is("textarea")&&!a.is(":button,:submit")){var b=false;$(this).find(":input:visible:not([disabled],[readonly]), a").each(function(){if(this===c.target){b=true}else{if(b){$(this).focus();return false}}});return false}}};ML.utils=new ML.Utils();ML.Settings=function(a){this.settings={site_url:a.site_url,static_url:a.hasOwnProperty("static_url")?a.static_url:"/static/",api_url:a.api_url,csrf_token:$.cookie("csrftoken")}};ML.Settings.prototype.getSettings=function(){return this.settings};ML.Settings.prototype.get=function(a){if(this.settings.hasOwnProperty(a)){return this.settings[a]}};ML.Application=function(a){ML.settings=new ML.Settings(a);this.init()};ML.Application.prototype.init=function(){this.version=null;if(location.search){var a=location.search.substr(1).split("&");for(var c in a){var b=a[c].split("=");if(b[0]=="version"){this.version=trim(b[1]);if(this.version==""){this.version=null}$.cookie("version",this.version,{path:"/"});location.search=location.search.replace("?"+a[c],"").replace("&"+a[c],"");break}}}if($.cookie("version")){this.version=$.cookie("version")}if(!this.version){if(platform.product){this.version="mobile"}else{this.version="desktop"}}if(this.version=="mobile"){$("head").append('<link rel="stylesheet" href="'+ML.settings.get("static_url")+'css/m.mumlife.css">')}else{$("head").append('<link rel="stylesheet" href="'+ML.settings.get("static_url")+'css/d.mumlife.css">')}this.load();new ML.Menu()};ML.Application.prototype.load=function(){var a=this;$(document).bind("mobileinit",function(){$.mobile.ajaxEnabled=false;$.mobile.linkBindingEnabled=false});if($("head").find('script[src="'+ML.settings.get("static_url")+'js/jquery.mobile-1.3.2.min.js"]').length==0){$.getScript(ML.settings.get("static_url")+"js/jquery.mobile-1.3.2.min.js",function(){a.ready()})}else{this.ready()}};ML.Application.prototype.ready=function(){$(document.body).show();setTimeout(function(){new ML.Notifications()},250);$(document).trigger("ml.Ready")};if(!window.ML){window.ML=ML}ML.Menu=function(){$('[data-entity="menu"]').click(function(){if($("#menu").is(":visible")){$("#menu").slideUp(250)}else{$("#menu").slideDown(250)}$(this).blur();return false})};ML.Notifications=function(){var b=$('[data-entity="notifications"]');if(b.size()>0){var a=ML.settings.get("site_url")+"notifications/";$("#notifications").popup({afteropen:function(c,d){$.mobile.loading("show");$("#notifications-content").html("<p><em>Loading notifications</em></p>");$("#notifications").popup("reposition",{x:0,y:0,positionTo:"body"});$.ajax({url:a,type:"GET",contentType:"text/html; charset=UTF-8",success:function(e){$.mobile.loading("hide");b.removeClass("active");$("#notifications-content").html(e);$("#notifications").popup("reposition",{x:0,y:0,positionTo:"body"})},error:function(f){$.mobile.loading("hide");console.log("FAILED -- "+f)}})},afterclose:function(c,d){$("#notifications-content").empty();$.mobile.loading("hide")}});b.on("click",function(){$("#notifications").popup("open");return false})}b.removeClass("invisible")};ML.Upload=function(c){this.url=ML.settings.get("site_url")+"upload";this.model=c.model;this.field=c.field;if(c.hasOwnProperty("width")){this.width=c.width}else{this.width="auto"}if(c.hasOwnProperty("height")){this.height=c.height}else{this.height="auto"}var a=this;$("input#"+this.field+"-clear_id").change(function(){ML.utils.set_image_visibility(a.field,!$(this).is(":checked"))});var b={csrfmiddlewaretoken:ML.settings.get("csrf_token"),model:this.model,field:this.field};if(this.width!=="auto"){b.width=this.width}if(this.height!=="auto"){b.height=this.height}$("input#id_"+this.field).ajaxfileupload({action:a.url,params:b,onComplete:function(f){if($("img."+a.field+"-edit").length>0){$("img."+a.field+"-edit").attr("src",f.filename)}else{var e=$("<img>");e.addClass(a.field+"-edit");e.attr("width",a.width);e.attr("height",a.height);e.attr("src",f.filename);$("input#id_"+a.field).before(e)}$("input#id_"+a.field+"_filepath").remove();var d=$("<input>");d.attr("type","hidden");d.val(f.filename);d.attr("name",a.field);d.attr("id","id_"+a.field+"_filepath");$("input#id_"+a.field).after(d);ML.utils.set_image_visibility(a.field,true)},onStart:function(){if($("img."+a.field+"-edit").length>0){ML.utils.set_image_visibility(a.field,false)}}})};ML.Feed=function(c){var a=this;this.loading=false;this.settings=c;this.button=$(".feed .ui-btn");this.button.click(function(){a.refresh();return false});if(c.hasOwnProperty("filters")&&c.filters){this.setFilters()}if(c.hasOwnProperty("slider")&&c.slider){var e=new RegExp(/\?range=\d+/g);var d=e.exec(location.search);if(d){var b=d.pop().split("=").pop();setTimeout(function(){$("#range").val(b);$("#range").slider("refresh")},250);$.cookie("ml_range",b)}$("#filter").on("click",function(f){a.slide($("#range").val());return false})}if(c.next!=""){this.button.show()}if(this.settings.hasOwnProperty("autoscroll")&&this.settings.autoscroll){$(window).scroll(function(){if(!a.loading&&c.next!=""){var f=$(".ui-page").height()-25;if($(document).scrollTop()+$(window).height()>=f){a.refresh()}}})}};ML.Feed.prototype.setFilters=function(){var b=$(".search-form").find('input[type="text"]').val();var c=new RegExp(/@\w+/g);var a=c.exec(b);a=a?a[0]:null;switch(a){case"@global":$('[data-role="filter-name"]').text("Global posts");$('[data-entity="filter"][rel="@local"]').removeClass("active");$('[data-entity="filter"][rel="@global"]').addClass("active");$('[data-entity="filter"][rel="@friends"]').removeClass("active");break;case"@friends":$('[data-role="filter-name"]').text("Friends' posts");$('[data-entity="filter"][rel="@local"]').removeClass("active");$('[data-entity="filter"][rel="@global"]').removeClass("active");$('[data-entity="filter"][rel="@friends"]').addClass("active");break;default:$('[data-role="filter-name"]').text("Local posts");$('[data-entity="filter"][rel="@local"]').addClass("active");$('[data-entity="filter"][rel="@global"]').removeClass("active");$('[data-entity="filter"][rel="@friends"]').removeClass("active")}$('[data-entity="filter"]').click(function(){var f=$(".search-form").find('input[type="text"]').val().split(" ");var d=[];for(var e in f){if(f[e].charAt(0)!="@"){d.push(escape(f[e]))}}d.push($(this).attr("rel"));location=trim(d.join(" "));return false})};ML.Feed.prototype.slide=function(c){var a=new RegExp(/\?range=(\d*)/g);var b=location.href;if(a.exec(b)){b=b.replace(a,"?range="+c)}else{b+="?range="+c}location=b};ML.Feed.prototype.refresh=function(){var a=this;this.loading=true;$.mobile.loading("show");this.button.remove();if(this.settings.next!=""){this.settings.next=this.settings.next.replace("&amp;","&");var b=ML.settings.get("site_url")+this.settings.next;$.ajax({url:b,type:"GET",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(c){$(".feed").append(c.html_content).append(a.button);a.button.click(function(){a.refresh();return false});a.settings.next=c.next;a.finish()},error:function(c){console.log("FAILED -- "+c);a.finish()}})}};ML.Feed.prototype.finish=function(){if(this.settings.next!=""){this.button.show();this.button.blur()}else{this.button.hide()}$.mobile.loading("hide");this.loading=false};ML.Messages=function(a){this.mode=a&&a.hasOwnProperty("edit-mode")&&a["edit-mode"]?"PATCH":"POST";this.event_id=a&&a.hasOwnProperty("event_id")?a.event_id:null;this.refresh()};ML.Messages.prototype.refresh=function(){var b=this;$("textarea.message-body").unbind();$("textarea.message-body").elastic();var c=$(".message-visibility").find('option[selected="selected"]');$('a[data-entity="message-type"]').each(function(){if($(this).data("type")==c.val()){$(this).addClass("selected")}});$('a[data-entity="message-type"]').click(function(){$('a[data-entity="message-type"]').removeClass("selected");$(this).addClass("selected");$(".message-visibility").find("option").attr("selected",null);$(".message-visibility").find('option[value="'+$(this).data("type")+'"]').attr("selected","selected");return false});function a(d){if(d==0){$('[data-entity="occurrence-until"]').slideUp(250)}else{$('[data-entity="occurrence-until"]').slideDown(250)}}a($('[data-entity="occurrence"] input:checked').val());$('[data-entity="occurrence"] input').off("change").on("change",function(){a($(this).val())});$('[data-entity="message"]').each(function(){var d=$(this);if(!d.data("bound")){d.data("bound",true);var e=null;if(d.data("type")=="private-message"){if(d.find('[data-entity="recipient"]').size()>0){d.find('[data-entity="recipient"]').on("click",function(){$(this).off("click").on("click",function(){return false});e=$(this).data("id");$(this).html('<p class="message-recipient">To: <strong>'+$(this).text()+"</strong></p>");$('[data-entity="friends-list"]').replaceWith($(this));return false})}else{e=d.data("recipient")}}d.find('[data-entity="button"]').bind("click",function(){var l=[];var f=trim(d.find(".message-body").val());var h=null;if(d.data("type")=="private-message"){h=0;if(!e){l.push("<p>Please select a friend</p>")}}else{h=d.find(".message-visibility").find('option[selected="selected"]').val()}var k={body:f,visibility:h,mid:d.data("mid"),recipient:e};if(b.event_id){k.id=b.event_id}var g=false;if(d.find(".message-name").length>0){g=true;k.name=d.find(".message-name").val();var i=d.find(".message-date").val();k.eventdate=i;if(d.find(".message-time").val()==""){k.eventdate+=" 00:00"}else{k.eventdate+=" "+d.find(".message-time").val()}if(d.find(".message-endtime").val()!=""){k.eventenddate=i+" "+d.find(".message-endtime").val()}k.location=d.find(".message-location").val();k.visibility=3;k.occurrence=parseInt(d.find('[data-entity="occurrence"] input:checked').val());k.occurs_until=d.find('[data-entity="occurrence-until"] input').val()}var j=true;d.find('*[required="required"]').each(function(){if($(this).val()==""){l.push("<p><strong>"+$(this).data("name")+"</strong> is required</p>")}});if(l.length>0){j=false;$("#errors-content").html(l.join(""));$("#errors").popup("open")}if(j){$.ajax({url:ML.settings.get("api_url")+"message/post",data:JSON.stringify(k),type:b.mode,contentType:"application/json; charset=UTF-8",dataType:"json",success:function(m){if(g){location=ML.settings.get("site_url")+"events/"}else{if(d.data("type")=="message"){location=ML.settings.get("site_url")}else{location.reload(true)}}},error:function(n){try{console.log("FAILED -- "+JSON.parse(n.responseText).detail)}catch(m){console.log("FAILED -- "+n)}}})}})}});$('a[data-entity="message"]').click(function(){var d=$(this);var e=$('div[data-entity="message"]');if(e.is(":visible")){e.slideUp(250,function(){e.find("textarea").val("")})}else{e.slideDown(250,function(){if(e.find('input[data-type="search"]').size()>0){e.find('input[data-type="search"]').focus()}else{e.find("textarea").focus()}})}return false})};ML.AutoField=function(b){var a=this;this.model=b.model;this.entity=b.entity;this.field=$("#id_"+b.field);this.widget=b.hasOwnProperty("widget")?b.widget:null;this.value=this.field.val();switch(this.widget){case"elastic":this.value=$("#id_"+b.field+"-twin").text();break;case"select":this.value=$("#id_"+b.field).data("value");var c=this.field.find("input");c.click(function(){a.field.val($(this).val());a.update()});break;case"date":this.field.on("change",function(){var d=a.field.val();if(d!==a.value){a.update()}});break}this.field.on("blur",function(){var d=a.field.val();if(d!==a.value){a.update()}});$(window).on("beforeunload",function(f){var d=a.field.val();if(d&&d!==a.value){a.update(function(){return true})}})};ML.AutoField.prototype.update=function(d){this.field.attr("disabled","disabled");var b=ML.settings.get("api_url")+this.model+"/"+this.entity+"/";var c={};c[this.field.attr("name")]=this.field.val();var a=this;$.ajax({url:b,data:JSON.stringify(c),async:false,type:"PATCH",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(e){a.done();if(typeof(d)=="function"){d()}},error:function(j){try{var h=["Oops something went wrong!\n"];var k=JSON.parse(j.responseText);for(var i in k){h.push(k[i])}alert(h.join("\n"))}catch(g){console.log("FAILED -- "+g)}a.done();if(typeof(d)=="function"){d()}}})};ML.AutoField.prototype.done=function(){this.value=this.field.val();this.field.attr("disabled",null)};ML.AddToFriends=function(b){this.classname=b["class"];var a=this;$("a."+this.classname).click(function(){var e=$(this);var g=e.attr("href").replace("#","").split(",");var d=ML.settings.get("api_url")+"friendships/";var c=0;if(e.attr("rel")=="block"){c=2}var f={from_member:parseInt(g[0]),to_member:parseInt(g[1]),status:c};$.ajax({url:d,data:JSON.stringify(f),type:"POST",contentType:"application/json; charset=UTF-8",dataType:"json",success:function(h){e.unbind("click").click(function(){return false});if(e.attr("rel")=="confirm"){e.find("img").removeClass("icon-addtofriend").addClass("icon-friend");e.find("span").text("Friend")}else{if(e.attr("rel")=="block"){e.find("img").removeClass("icon-addtofriend").addClass("icon-addtofriend");e.find("span").text("Blocked")}else{e.find("img").removeClass("icon-addtofriend").addClass("icon-pendingfriend");e.find("span").text("Requested")}}},error:function(i){try{if(JSON.parse(i.responseText).detail=="Already Exists"){}}catch(h){console.log("FAILED -- "+h)}}});return false})};
